FROM ubuntu:14.04

RUN apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 7F0CEB10

ENV MONGO_MAJOR 3.0
RUN echo "deb http://repo.mongodb.org/apt/debian wheezy/mongodb-org/$MONGO_MAJOR main" > /etc/apt/sources.list.d/mongodb-org.list

# Install MongoDB
RUN apt-get update
RUN sudo apt-get install -y mongodb-org=3.0.4 mongodb-org-server=3.0.4 mongodb-org-shell=3.0.4 mongodb-org-mongos=3.0.4 mongodb-org-tools=3.0.4

#System kernel 
#RUN echo never >>  /sys/kernel/mm/transparent_hugepage/enabled \
#&& echo never >>  /sys/kernel/mm/transparent_hugepage/defrag

# Create the MongoDB data directory
RUN mkdir -p /usr/local/mongo/conf \
&& mkdir -p /usr/local/mongo/data \
&& mkdir -p /usr/local/mongo/log

# Copy conf
ADD ./conf.d/mongo.conf /usr/local/mongo/conf/mongo.conf
ADD ./prepairation/init.sh /init.sh

# Crteate the MongoDB user
RUN useradd -u800 mongod \
&& echo mongod:123456 | chpasswd \
&& chown -R mongod.mongod /usr/local/mongo \
&& chown mongod.mongod /usr/bin/mongod /usr/bin/mongos \
&& chmod a+x /init.sh
EXPOSE 27017
USER mongod

ENTRYPOINT ["usr/bin/mongod","-f","/usr/local/mongo/conf/mongo.conf"]
